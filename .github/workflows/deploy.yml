name: Deploy site

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deploy-pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      #- name: Merge ready PRs (optional)
      #  run: |
      #    git checkout main
      #    bash bin/merge_prs.sh
      #  env:
      #    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Ruby ğŸ’
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.5"
          bundler-cache: true

      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Update _config.yml (giscus) âš™ï¸
        uses: fjogeleit/yaml-update-action@v0.16.0
        with:
          commitChange: false
          valueFile: "_config.yml"
          propertyPath: "giscus.repo"
          value: ${{ github.repository }}

      - name: Install system deps ğŸ”§
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Install Python deps ğŸ”§
        run: |
          pip3 install --upgrade nbconvert

            - name: Build Jekyll ğŸ—ï¸
        env:
          JEKYLL_ENV: production
        run: |
          set -euo pipefail
          bundle exec jekyll build --future --trace

      - name: Debug: list build output + require index.html
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "Top-level files:"
          ls -la | head -n 200

          echo "Config sanity:"
          ruby -v
          bundle -v
          bundle exec jekyll -v || true
          echo "baseurl from _config.yml:"
          grep -nE '^(url:|baseurl:)' _config.yml || true

          echo "Listing _site:"
          ls -la _site || true
          echo "Looking for index.html:"
          find _site -maxdepth 2 -name index.html -print || true

          test -f _site/index.html

          # recommended for GitHub Pages hosting of prebuilt sites:
          touch _site/.nojekyll

      - name: Purge unused CSS ğŸ§¹
        run: |
          npm install -g purgecss
          purgecss -c purgecss.config.js

      - name: Deploy to gh-pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: _site
          clean: true




     